<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SurvivalSlimefunGuide.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Slimefun</a> &gt; <a href="index.source.html" class="el_package">io.github.thebusybiscuit.slimefun4.implementation.guide</a> &gt; <span class="el_source">SurvivalSlimefunGuide.java</span></div><h1>SurvivalSlimefunGuide.java</h1><pre class="source lang-java linenums">package io.github.thebusybiscuit.slimefun4.implementation.guide;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.LinkedList;
import java.util.List;
import java.util.Locale;
import java.util.Optional;
import java.util.logging.Level;

import javax.annotation.Nonnull;
import javax.annotation.ParametersAreNonnullByDefault;

import org.apache.commons.lang.Validate;
import org.bukkit.ChatColor;
import org.bukkit.Material;
import org.bukkit.Sound;
import org.bukkit.Tag;
import org.bukkit.entity.Player;
import org.bukkit.inventory.Inventory;
import org.bukkit.inventory.ItemFlag;
import org.bukkit.inventory.ItemStack;
import org.bukkit.inventory.Recipe;
import org.bukkit.inventory.RecipeChoice;
import org.bukkit.inventory.RecipeChoice.MaterialChoice;

import io.github.bakedlibs.dough.chat.ChatInput;
import io.github.bakedlibs.dough.items.CustomItemStack;
import io.github.bakedlibs.dough.items.ItemUtils;
import io.github.bakedlibs.dough.recipes.MinecraftRecipe;
import io.github.thebusybiscuit.slimefun4.api.SlimefunAddon;
import io.github.thebusybiscuit.slimefun4.api.items.ItemGroup;
import io.github.thebusybiscuit.slimefun4.api.items.SlimefunItem;
import io.github.thebusybiscuit.slimefun4.api.items.groups.FlexItemGroup;
import io.github.thebusybiscuit.slimefun4.api.items.groups.LockedItemGroup;
import io.github.thebusybiscuit.slimefun4.api.player.PlayerProfile;
import io.github.thebusybiscuit.slimefun4.api.recipes.RecipeType;
import io.github.thebusybiscuit.slimefun4.api.researches.Research;
import io.github.thebusybiscuit.slimefun4.core.attributes.RecipeDisplayItem;
import io.github.thebusybiscuit.slimefun4.core.guide.GuideHistory;
import io.github.thebusybiscuit.slimefun4.core.guide.SlimefunGuide;
import io.github.thebusybiscuit.slimefun4.core.guide.SlimefunGuideImplementation;
import io.github.thebusybiscuit.slimefun4.core.guide.SlimefunGuideMode;
import io.github.thebusybiscuit.slimefun4.core.guide.options.SlimefunGuideSettings;
import io.github.thebusybiscuit.slimefun4.core.multiblocks.MultiBlock;
import io.github.thebusybiscuit.slimefun4.core.multiblocks.MultiBlockMachine;
import io.github.thebusybiscuit.slimefun4.implementation.Slimefun;
import io.github.thebusybiscuit.slimefun4.implementation.tasks.AsyncRecipeChoiceTask;
import io.github.thebusybiscuit.slimefun4.utils.ChatUtils;
import io.github.thebusybiscuit.slimefun4.utils.ChestMenuUtils;
import io.github.thebusybiscuit.slimefun4.utils.itemstack.SlimefunGuideItem;

import me.mrCookieSlime.CSCoreLibPlugin.general.Inventory.ChestMenu;
import me.mrCookieSlime.CSCoreLibPlugin.general.Inventory.ChestMenu.MenuClickHandler;

/**
 * The {@link SurvivalSlimefunGuide} is the standard version of our {@link SlimefunGuide}.
 * It uses an {@link Inventory} to display {@link SlimefunGuide} contents.
 *
 * @author TheBusyBiscuit
 * 
 * @see SlimefunGuide
 * @see SlimefunGuideImplementation
 * @see CheatSheetSlimefunGuide
 *
 */
public class SurvivalSlimefunGuide implements SlimefunGuideImplementation {

    private static final int MAX_ITEM_GROUPS = 36;
<span class="fc" id="L70">    private static final Sound sound = Sound.ITEM_BOOK_PAGE_TURN;</span>

<span class="fc" id="L72">    private final int[] recipeSlots = { 3, 4, 5, 12, 13, 14, 21, 22, 23 };</span>
    private final ItemStack item;
    private final boolean showVanillaRecipes;
    private final boolean showHiddenItemGroupsInSearch;

<span class="fc" id="L77">    public SurvivalSlimefunGuide(boolean showVanillaRecipes, boolean showHiddenItemGroupsInSearch) {</span>
<span class="fc" id="L78">        this.showVanillaRecipes = showVanillaRecipes;</span>
<span class="fc" id="L79">        this.showHiddenItemGroupsInSearch = showHiddenItemGroupsInSearch;</span>
<span class="fc" id="L80">        item = new SlimefunGuideItem(this, &quot;&amp;aSlimefun Guide &amp;7(Chest GUI)&quot;);</span>
<span class="fc" id="L81">    }</span>

    /**
     * This returns the {@link Sound} which is played when someone navigates through
     * the {@link SlimefunGuide}
     * 
     * @return The {@link Sound}
     */
    public @Nonnull Sound getSound() {
<span class="nc" id="L90">        return sound;</span>
    }

    @Override
    public @Nonnull SlimefunGuideMode getMode() {
<span class="fc" id="L95">        return SlimefunGuideMode.SURVIVAL_MODE;</span>
    }

    @Override
    public @Nonnull ItemStack getItem() {
<span class="fc" id="L100">        return item;</span>
    }

    protected final boolean isSurvivalMode() {
<span class="nc bnc" id="L104" title="All 2 branches missed.">        return getMode() != SlimefunGuideMode.CHEAT_MODE;</span>
    }

    /**
     * Returns a {@link List} of visible {@link ItemGroup} instances that the {@link SlimefunGuide} would display.
     *
     * @param p
     *            The {@link Player} who opened his {@link SlimefunGuide}
     * @param profile
     *            The {@link PlayerProfile} of the {@link Player}
     * 
     * @return a {@link List} of visible {@link ItemGroup} instances
     */
    protected @Nonnull List&lt;ItemGroup&gt; getVisibleItemGroups(@Nonnull Player p, @Nonnull PlayerProfile profile) {
<span class="nc" id="L118">        List&lt;ItemGroup&gt; groups = new LinkedList&lt;&gt;();</span>

<span class="nc bnc" id="L120" title="All 2 branches missed.">        for (ItemGroup group : Slimefun.getRegistry().getAllItemGroups()) {</span>
            try {
<span class="nc bnc" id="L122" title="All 2 branches missed.">                if (group instanceof FlexItemGroup flexItemGroup) {</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">                    if (flexItemGroup.isVisible(p, profile, getMode())) {</span>
<span class="nc" id="L124">                        groups.add(group);</span>
                    }
<span class="nc bnc" id="L126" title="All 2 branches missed.">                } else if (!group.isHidden(p)) {</span>
<span class="nc" id="L127">                    groups.add(group);</span>
                }
<span class="nc" id="L129">            } catch (Exception | LinkageError x) {</span>
<span class="nc" id="L130">                SlimefunAddon addon = group.getAddon();</span>

<span class="nc bnc" id="L132" title="All 2 branches missed.">                if (addon != null) {</span>
<span class="nc" id="L133">                    addon.getLogger().log(Level.SEVERE, x, () -&gt; &quot;Could not display item group: &quot; + group);</span>
                } else {
<span class="nc" id="L135">                    Slimefun.logger().log(Level.SEVERE, x, () -&gt; &quot;Could not display item group: &quot; + group);</span>
                }
<span class="nc" id="L137">            }</span>
<span class="nc" id="L138">        }</span>

<span class="nc" id="L140">        return groups;</span>
    }

    @Override
    public void openMainMenu(PlayerProfile profile, int page) {
<span class="nc" id="L145">        Player p = profile.getPlayer();</span>

<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (p == null) {</span>
<span class="nc" id="L148">            return;</span>
        }

<span class="nc bnc" id="L151" title="All 2 branches missed.">        if (isSurvivalMode()) {</span>
<span class="nc" id="L152">            GuideHistory history = profile.getGuideHistory();</span>
<span class="nc" id="L153">            history.clear();</span>
<span class="nc" id="L154">            history.setMainMenuPage(page);</span>
        }

<span class="nc" id="L157">        ChestMenu menu = create(p);</span>
<span class="nc" id="L158">        List&lt;ItemGroup&gt; itemGroups = getVisibleItemGroups(p, profile);</span>

<span class="nc" id="L160">        int index = 9;</span>
<span class="nc" id="L161">        createHeader(p, profile, menu);</span>

<span class="nc" id="L163">        int target = (MAX_ITEM_GROUPS * (page - 1)) - 1;</span>

<span class="nc bnc" id="L165" title="All 4 branches missed.">        while (target &lt; (itemGroups.size() - 1) &amp;&amp; index &lt; MAX_ITEM_GROUPS + 9) {</span>
<span class="nc" id="L166">            target++;</span>

<span class="nc" id="L168">            ItemGroup group = itemGroups.get(target);</span>
<span class="nc" id="L169">            showItemGroup(menu, p, profile, group, index);</span>

<span class="nc" id="L171">            index++;</span>
<span class="nc" id="L172">        }</span>

<span class="nc bnc" id="L174" title="All 2 branches missed.">        int pages = target == itemGroups.size() - 1 ? page : (itemGroups.size() - 1) / MAX_ITEM_GROUPS + 1;</span>

<span class="nc" id="L176">        menu.addItem(46, ChestMenuUtils.getPreviousButton(p, page, pages));</span>
<span class="nc" id="L177">        menu.addMenuClickHandler(46, (pl, slot, item, action) -&gt; {</span>
<span class="nc" id="L178">            int next = page - 1;</span>

<span class="nc bnc" id="L180" title="All 4 branches missed.">            if (next != page &amp;&amp; next &gt; 0) {</span>
<span class="nc" id="L181">                openMainMenu(profile, next);</span>
            }

<span class="nc" id="L184">            return false;</span>
        });

<span class="nc" id="L187">        menu.addItem(52, ChestMenuUtils.getNextButton(p, page, pages));</span>
<span class="nc" id="L188">        menu.addMenuClickHandler(52, (pl, slot, item, action) -&gt; {</span>
<span class="nc" id="L189">            int next = page + 1;</span>

<span class="nc bnc" id="L191" title="All 4 branches missed.">            if (next != page &amp;&amp; next &lt;= pages) {</span>
<span class="nc" id="L192">                openMainMenu(profile, next);</span>
            }

<span class="nc" id="L195">            return false;</span>
        });

<span class="nc" id="L198">        menu.open(p);</span>
<span class="nc" id="L199">    }</span>

    private void showItemGroup(ChestMenu menu, Player p, PlayerProfile profile, ItemGroup group, int index) {
<span class="nc bnc" id="L202" title="All 6 branches missed.">        if (!(group instanceof LockedItemGroup) || !isSurvivalMode() || ((LockedItemGroup) group).hasUnlocked(p, profile)) {</span>
<span class="nc" id="L203">            menu.addItem(index, group.getItem(p));</span>
<span class="nc" id="L204">            menu.addMenuClickHandler(index, (pl, slot, item, action) -&gt; {</span>
<span class="nc" id="L205">                openItemGroup(profile, group, 1);</span>
<span class="nc" id="L206">                return false;</span>
            });
        } else {
<span class="nc" id="L209">            List&lt;String&gt; lore = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L210">            lore.add(&quot;&quot;);</span>

<span class="nc bnc" id="L212" title="All 2 branches missed.">            for (String line : Slimefun.getLocalization().getMessages(p, &quot;guide.locked-itemgroup&quot;)) {</span>
<span class="nc" id="L213">                lore.add(ChatColor.WHITE + line);</span>
<span class="nc" id="L214">            }</span>

<span class="nc" id="L216">            lore.add(&quot;&quot;);</span>

<span class="nc bnc" id="L218" title="All 2 branches missed.">            for (ItemGroup parent : ((LockedItemGroup) group).getParents()) {</span>
<span class="nc" id="L219">                lore.add(parent.getItem(p).getItemMeta().getDisplayName());</span>
<span class="nc" id="L220">            }</span>

<span class="nc" id="L222">            menu.addItem(index, new CustomItemStack(Material.BARRIER, &quot;&amp;4&quot; + Slimefun.getLocalization().getMessage(p, &quot;guide.locked&quot;) + &quot; &amp;7- &amp;f&quot; + group.getItem(p).getItemMeta().getDisplayName(), lore.toArray(new String[0])));</span>
<span class="nc" id="L223">            menu.addMenuClickHandler(index, ChestMenuUtils.getEmptyClickHandler());</span>
        }
<span class="nc" id="L225">    }</span>

    @Override
    @ParametersAreNonnullByDefault
    public void openItemGroup(PlayerProfile profile, ItemGroup itemGroup, int page) {
<span class="nc" id="L230">        Player p = profile.getPlayer();</span>

<span class="nc bnc" id="L232" title="All 2 branches missed.">        if (p == null) {</span>
<span class="nc" id="L233">            return;</span>
        }

<span class="nc bnc" id="L236" title="All 2 branches missed.">        if (itemGroup instanceof FlexItemGroup flexItemGroup) {</span>
<span class="nc" id="L237">            flexItemGroup.open(p, profile, getMode());</span>
<span class="nc" id="L238">            return;</span>
        }

<span class="nc bnc" id="L241" title="All 2 branches missed.">        if (isSurvivalMode()) {</span>
<span class="nc" id="L242">            profile.getGuideHistory().add(itemGroup, page);</span>
        }

<span class="nc" id="L245">        ChestMenu menu = create(p);</span>
<span class="nc" id="L246">        createHeader(p, profile, menu);</span>

<span class="nc" id="L248">        addBackButton(menu, 1, p, profile);</span>

<span class="nc" id="L250">        int pages = (itemGroup.getItems().size() - 1) / MAX_ITEM_GROUPS + 1;</span>

<span class="nc" id="L252">        menu.addItem(46, ChestMenuUtils.getPreviousButton(p, page, pages));</span>
<span class="nc" id="L253">        menu.addMenuClickHandler(46, (pl, slot, item, action) -&gt; {</span>
<span class="nc" id="L254">            int next = page - 1;</span>

<span class="nc bnc" id="L256" title="All 4 branches missed.">            if (next != page &amp;&amp; next &gt; 0) {</span>
<span class="nc" id="L257">                openItemGroup(profile, itemGroup, next);</span>
            }

<span class="nc" id="L260">            return false;</span>
        });

<span class="nc" id="L263">        menu.addItem(52, ChestMenuUtils.getNextButton(p, page, pages));</span>
<span class="nc" id="L264">        menu.addMenuClickHandler(52, (pl, slot, item, action) -&gt; {</span>
<span class="nc" id="L265">            int next = page + 1;</span>

<span class="nc bnc" id="L267" title="All 4 branches missed.">            if (next != page &amp;&amp; next &lt;= pages) {</span>
<span class="nc" id="L268">                openItemGroup(profile, itemGroup, next);</span>
            }

<span class="nc" id="L271">            return false;</span>
        });

<span class="nc" id="L274">        int index = 9;</span>
<span class="nc" id="L275">        int itemGroupIndex = MAX_ITEM_GROUPS * (page - 1);</span>

<span class="nc bnc" id="L277" title="All 2 branches missed.">        for (int i = 0; i &lt; MAX_ITEM_GROUPS; i++) {</span>
<span class="nc" id="L278">            int target = itemGroupIndex + i;</span>

<span class="nc bnc" id="L280" title="All 2 branches missed.">            if (target &gt;= itemGroup.getItems().size()) {</span>
<span class="nc" id="L281">                break;</span>
            }

<span class="nc" id="L284">            SlimefunItem sfitem = itemGroup.getItems().get(target);</span>

<span class="nc bnc" id="L286" title="All 2 branches missed.">            if (!sfitem.isDisabledIn(p.getWorld())) {</span>
<span class="nc" id="L287">                displaySlimefunItem(menu, itemGroup, p, profile, sfitem, page, index);</span>
<span class="nc" id="L288">                index++;</span>
            }
        }

<span class="nc" id="L292">        menu.open(p);</span>
<span class="nc" id="L293">    }</span>

    private void displaySlimefunItem(ChestMenu menu, ItemGroup itemGroup, Player p, PlayerProfile profile, SlimefunItem sfitem, int page, int index) {
<span class="nc" id="L296">        Research research = sfitem.getResearch();</span>

<span class="nc bnc" id="L298" title="All 4 branches missed.">        if (isSurvivalMode() &amp;&amp; !hasPermission(p, sfitem)) {</span>
<span class="nc" id="L299">            List&lt;String&gt; message = Slimefun.getPermissionsService().getLore(sfitem);</span>
<span class="nc" id="L300">            menu.addItem(index, new CustomItemStack(ChestMenuUtils.getNoPermissionItem(), sfitem.getItemName(), message.toArray(new String[0])));</span>
<span class="nc" id="L301">            menu.addMenuClickHandler(index, ChestMenuUtils.getEmptyClickHandler());</span>
<span class="nc bnc" id="L302" title="All 6 branches missed.">        } else if (isSurvivalMode() &amp;&amp; research != null &amp;&amp; !profile.hasUnlocked(research)) {</span>
<span class="nc" id="L303">            menu.addItem(index, new CustomItemStack(ChestMenuUtils.getNotResearchedItem(), ChatColor.WHITE + ItemUtils.getItemName(sfitem.getItem()), &quot;&amp;4&amp;l&quot; + Slimefun.getLocalization().getMessage(p, &quot;guide.locked&quot;), &quot;&quot;, &quot;&amp;a&gt; Click to unlock&quot;, &quot;&quot;, &quot;&amp;7Cost: &amp;b&quot; + research.getCost() + &quot; Level(s)&quot;));</span>
<span class="nc" id="L304">            menu.addMenuClickHandler(index, (pl, slot, item, action) -&gt; {</span>
<span class="nc" id="L305">                research.unlockFromGuide(this, p, profile, sfitem, itemGroup, page);</span>
<span class="nc" id="L306">                return false;</span>
            });
        } else {
<span class="nc" id="L309">            menu.addItem(index, sfitem.getItem());</span>
<span class="nc" id="L310">            menu.addMenuClickHandler(index, (pl, slot, item, action) -&gt; {</span>
                try {
<span class="nc bnc" id="L312" title="All 2 branches missed.">                    if (isSurvivalMode()) {</span>
<span class="nc" id="L313">                        displayItem(profile, sfitem, true);</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">                    } else if (pl.hasPermission(&quot;slimefun.cheat.items&quot;)) {</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">                        if (sfitem instanceof MultiBlockMachine) {</span>
<span class="nc" id="L316">                            Slimefun.getLocalization().sendMessage(pl, &quot;guide.cheat.no-multiblocks&quot;);</span>
                        } else {
<span class="nc" id="L318">                            ItemStack clonedItem = sfitem.getItem().clone();</span>

<span class="nc bnc" id="L320" title="All 2 branches missed.">                            if (action.isShiftClicked()) {</span>
<span class="nc" id="L321">                                clonedItem.setAmount(clonedItem.getMaxStackSize());</span>
                            }

<span class="nc" id="L324">                            pl.getInventory().addItem(clonedItem);</span>
<span class="nc" id="L325">                        }</span>
                    } else {
                        /*
                         * Fixes #3548 - If for whatever reason,
                         * an unpermitted players gets access to this guide,
                         * this will be our last line of defense to prevent any exploit.
                         */
<span class="nc" id="L332">                        Slimefun.getLocalization().sendMessage(pl, &quot;messages.no-permission&quot;, true);</span>
                    }
<span class="nc" id="L334">                } catch (Exception | LinkageError x) {</span>
<span class="nc" id="L335">                    printErrorMessage(pl, sfitem, x);</span>
<span class="nc" id="L336">                }</span>

<span class="nc" id="L338">                return false;</span>
            });
        }
<span class="nc" id="L341">    }</span>

    @Override
    @ParametersAreNonnullByDefault
    public void openSearch(PlayerProfile profile, String input, boolean addToHistory) {
<span class="nc" id="L346">        Player p = profile.getPlayer();</span>

<span class="nc bnc" id="L348" title="All 2 branches missed.">        if (p == null) {</span>
<span class="nc" id="L349">            return;</span>
        }

<span class="nc" id="L352">        ChestMenu menu = new ChestMenu(Slimefun.getLocalization().getMessage(p, &quot;guide.search.inventory&quot;).replace(&quot;%item%&quot;, ChatUtils.crop(ChatColor.WHITE, input)));</span>
<span class="nc" id="L353">        String searchTerm = input.toLowerCase(Locale.ROOT);</span>

<span class="nc bnc" id="L355" title="All 2 branches missed.">        if (addToHistory) {</span>
<span class="nc" id="L356">            profile.getGuideHistory().add(searchTerm);</span>
        }

<span class="nc" id="L359">        menu.setEmptySlotsClickable(false);</span>
<span class="nc" id="L360">        createHeader(p, profile, menu);</span>
<span class="nc" id="L361">        addBackButton(menu, 1, p, profile);</span>

<span class="nc" id="L363">        int index = 9;</span>
        // Find items and add them
<span class="nc bnc" id="L365" title="All 2 branches missed.">        for (SlimefunItem slimefunItem : Slimefun.getRegistry().getEnabledSlimefunItems()) {</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">            if (index == 44) {</span>
<span class="nc" id="L367">                break;</span>
            }

<span class="nc bnc" id="L370" title="All 6 branches missed.">            if (!slimefunItem.isHidden() &amp;&amp; isItemGroupAccessible(p, slimefunItem) &amp;&amp; isSearchFilterApplicable(slimefunItem, searchTerm)) {</span>
<span class="nc" id="L371">                ItemStack itemstack = new CustomItemStack(slimefunItem.getItem(), meta -&gt; {</span>
<span class="nc" id="L372">                    ItemGroup itemGroup = slimefunItem.getItemGroup();</span>
<span class="nc" id="L373">                    meta.setLore(Arrays.asList(&quot;&quot;, ChatColor.DARK_GRAY + &quot;\u21E8 &quot; + ChatColor.WHITE + itemGroup.getDisplayName(p)));</span>
<span class="nc" id="L374">                    meta.addItemFlags(ItemFlag.HIDE_ATTRIBUTES, ItemFlag.HIDE_ENCHANTS, ItemFlag.HIDE_POTION_EFFECTS);</span>
<span class="nc" id="L375">                });</span>

<span class="nc" id="L377">                menu.addItem(index, itemstack);</span>
<span class="nc" id="L378">                menu.addMenuClickHandler(index, (pl, slot, itm, action) -&gt; {</span>
                    try {
<span class="nc bnc" id="L380" title="All 2 branches missed.">                        if (!isSurvivalMode()) {</span>
<span class="nc" id="L381">                            pl.getInventory().addItem(slimefunItem.getItem().clone());</span>
                        } else {
<span class="nc" id="L383">                            displayItem(profile, slimefunItem, true);</span>
                        }
<span class="nc" id="L385">                    } catch (Exception | LinkageError x) {</span>
<span class="nc" id="L386">                        printErrorMessage(pl, slimefunItem, x);</span>
<span class="nc" id="L387">                    }</span>

<span class="nc" id="L389">                    return false;</span>
                });

<span class="nc" id="L392">                index++;</span>
            }
<span class="nc" id="L394">        }</span>

<span class="nc" id="L396">        menu.open(p);</span>
<span class="nc" id="L397">    }</span>

    @ParametersAreNonnullByDefault
    private boolean isItemGroupAccessible(Player p, SlimefunItem slimefunItem) {
<span class="nc bnc" id="L401" title="All 4 branches missed.">        return showHiddenItemGroupsInSearch || slimefunItem.getItemGroup().isAccessible(p);</span>
    }

    @ParametersAreNonnullByDefault
    private boolean isSearchFilterApplicable(SlimefunItem slimefunItem, String searchTerm) {
<span class="nc" id="L406">        String itemName = ChatColor.stripColor(slimefunItem.getItemName()).toLowerCase(Locale.ROOT);</span>
<span class="nc bnc" id="L407" title="All 6 branches missed.">        return !itemName.isEmpty() &amp;&amp; (itemName.equals(searchTerm) || itemName.contains(searchTerm));</span>
    }

    @Override
    @ParametersAreNonnullByDefault
    public void displayItem(PlayerProfile profile, ItemStack item, int index, boolean addToHistory) {
<span class="nc" id="L413">        Player p = profile.getPlayer();</span>

<span class="nc bnc" id="L415" title="All 6 branches missed.">        if (p == null || item == null || item.getType() == Material.AIR) {</span>
<span class="nc" id="L416">            return;</span>
        }

<span class="nc" id="L419">        SlimefunItem sfItem = SlimefunItem.getByItem(item);</span>

<span class="nc bnc" id="L421" title="All 2 branches missed.">        if (sfItem != null) {</span>
<span class="nc" id="L422">            displayItem(profile, sfItem, addToHistory);</span>
<span class="nc" id="L423">            return;</span>
        }

<span class="nc bnc" id="L426" title="All 2 branches missed.">        if (!showVanillaRecipes) {</span>
<span class="nc" id="L427">            return;</span>
        }

<span class="nc" id="L430">        Recipe[] recipes = Slimefun.getMinecraftRecipeService().getRecipesFor(item);</span>

<span class="nc bnc" id="L432" title="All 2 branches missed.">        if (recipes.length == 0) {</span>
<span class="nc" id="L433">            return;</span>
        }

<span class="nc" id="L436">        showMinecraftRecipe(recipes, index, item, profile, p, addToHistory);</span>
<span class="nc" id="L437">    }</span>

    private void showMinecraftRecipe(Recipe[] recipes, int index, ItemStack item, PlayerProfile profile, Player p, boolean addToHistory) {
<span class="nc" id="L440">        Recipe recipe = recipes[index];</span>

<span class="nc" id="L442">        ItemStack[] recipeItems = new ItemStack[9];</span>
<span class="nc" id="L443">        RecipeType recipeType = RecipeType.NULL;</span>
<span class="nc" id="L444">        ItemStack result = null;</span>

<span class="nc" id="L446">        Optional&lt;MinecraftRecipe&lt;? super Recipe&gt;&gt; optional = MinecraftRecipe.of(recipe);</span>
<span class="nc" id="L447">        AsyncRecipeChoiceTask task = new AsyncRecipeChoiceTask();</span>

<span class="nc bnc" id="L449" title="All 2 branches missed.">        if (optional.isPresent()) {</span>
<span class="nc" id="L450">            showRecipeChoices(recipe, recipeItems, task);</span>

<span class="nc" id="L452">            recipeType = new RecipeType(optional.get());</span>
<span class="nc" id="L453">            result = recipe.getResult();</span>
        } else {
<span class="nc" id="L455">            recipeItems = new ItemStack[] { null, null, null, null, new CustomItemStack(Material.BARRIER, &quot;&amp;4We are somehow unable to show you this Recipe :/&quot;), null, null, null, null };</span>
        }

<span class="nc" id="L458">        ChestMenu menu = create(p);</span>

<span class="nc bnc" id="L460" title="All 2 branches missed.">        if (addToHistory) {</span>
<span class="nc" id="L461">            profile.getGuideHistory().add(item, index);</span>
        }

<span class="nc" id="L464">        displayItem(menu, profile, p, item, result, recipeType, recipeItems, task);</span>

<span class="nc bnc" id="L466" title="All 2 branches missed.">        if (recipes.length &gt; 1) {</span>
<span class="nc bnc" id="L467" title="All 2 branches missed.">            for (int i = 27; i &lt; 36; i++) {</span>
<span class="nc" id="L468">                menu.addItem(i, ChestMenuUtils.getBackground(), ChestMenuUtils.getEmptyClickHandler());</span>
            }

<span class="nc" id="L471">            menu.addItem(28, ChestMenuUtils.getPreviousButton(p, index + 1, recipes.length), (pl, slot, action, stack) -&gt; {</span>
<span class="nc bnc" id="L472" title="All 2 branches missed.">                if (index &gt; 0) {</span>
<span class="nc" id="L473">                    showMinecraftRecipe(recipes, index - 1, item, profile, p, true);</span>
                }
<span class="nc" id="L475">                return false;</span>
            });

<span class="nc" id="L478">            menu.addItem(34, ChestMenuUtils.getNextButton(p, index + 1, recipes.length), (pl, slot, action, stack) -&gt; {</span>
<span class="nc bnc" id="L479" title="All 2 branches missed.">                if (index &lt; recipes.length - 1) {</span>
<span class="nc" id="L480">                    showMinecraftRecipe(recipes, index + 1, item, profile, p, true);</span>
                }
<span class="nc" id="L482">                return false;</span>
            });
        }

<span class="nc" id="L486">        menu.open(p);</span>

<span class="nc bnc" id="L488" title="All 2 branches missed.">        if (!task.isEmpty()) {</span>
<span class="nc" id="L489">            task.start(menu.toInventory());</span>
        }
<span class="nc" id="L491">    }</span>

    private &lt;T extends Recipe&gt; void showRecipeChoices(T recipe, ItemStack[] recipeItems, AsyncRecipeChoiceTask task) {
<span class="nc" id="L494">        RecipeChoice[] choices = Slimefun.getMinecraftRecipeService().getRecipeShape(recipe);</span>

<span class="nc bnc" id="L496" title="All 4 branches missed.">        if (choices.length == 1 &amp;&amp; choices[0] instanceof MaterialChoice materialChoice) {</span>
<span class="nc" id="L497">            recipeItems[4] = new ItemStack(materialChoice.getChoices().get(0));</span>

<span class="nc bnc" id="L499" title="All 2 branches missed.">            if (materialChoice.getChoices().size() &gt; 1) {</span>
<span class="nc" id="L500">                task.add(recipeSlots[4], materialChoice);</span>
            }
        } else {
<span class="nc bnc" id="L503" title="All 2 branches missed.">            for (int i = 0; i &lt; choices.length; i++) {</span>
<span class="nc bnc" id="L504" title="All 2 branches missed.">                if (choices[i] instanceof MaterialChoice materialChoice) {</span>
<span class="nc" id="L505">                    recipeItems[i] = new ItemStack(materialChoice.getChoices().get(0));</span>

<span class="nc bnc" id="L507" title="All 2 branches missed.">                    if (materialChoice.getChoices().size() &gt; 1) {</span>
<span class="nc" id="L508">                        task.add(recipeSlots[i], materialChoice);</span>
                    }
                }
            }
        }
<span class="nc" id="L513">    }</span>

    @Override
    @ParametersAreNonnullByDefault
    public void displayItem(PlayerProfile profile, SlimefunItem item, boolean addToHistory) {
<span class="nc" id="L518">        Player p = profile.getPlayer();</span>

<span class="nc bnc" id="L520" title="All 2 branches missed.">        if (p == null) {</span>
<span class="nc" id="L521">            return;</span>
        }

<span class="nc" id="L524">        ChestMenu menu = create(p);</span>
<span class="nc" id="L525">        Optional&lt;String&gt; wiki = item.getWikipage();</span>

<span class="nc bnc" id="L527" title="All 2 branches missed.">        if (wiki.isPresent()) {</span>
<span class="nc" id="L528">            menu.addItem(8, new CustomItemStack(Material.KNOWLEDGE_BOOK, ChatColor.WHITE + Slimefun.getLocalization().getMessage(p, &quot;guide.tooltips.wiki&quot;), &quot;&quot;, ChatColor.GRAY + &quot;\u21E8 &quot; + ChatColor.GREEN + Slimefun.getLocalization().getMessage(p, &quot;guide.tooltips.open-itemgroup&quot;)));</span>
<span class="nc" id="L529">            menu.addMenuClickHandler(8, (pl, slot, itemstack, action) -&gt; {</span>
<span class="nc" id="L530">                pl.closeInventory();</span>
<span class="nc" id="L531">                ChatUtils.sendURL(pl, wiki.get());</span>
<span class="nc" id="L532">                return false;</span>
            });
        }

<span class="nc" id="L536">        AsyncRecipeChoiceTask task = new AsyncRecipeChoiceTask();</span>

<span class="nc bnc" id="L538" title="All 2 branches missed.">        if (addToHistory) {</span>
<span class="nc" id="L539">            profile.getGuideHistory().add(item);</span>
        }

<span class="nc" id="L542">        ItemStack result = item.getRecipeOutput();</span>
<span class="nc" id="L543">        RecipeType recipeType = item.getRecipeType();</span>
<span class="nc" id="L544">        ItemStack[] recipe = item.getRecipe();</span>

<span class="nc" id="L546">        displayItem(menu, profile, p, item, result, recipeType, recipe, task);</span>

<span class="nc bnc" id="L548" title="All 2 branches missed.">        if (item instanceof RecipeDisplayItem recipeDisplayItem) {</span>
<span class="nc" id="L549">            displayRecipes(p, profile, menu, recipeDisplayItem, 0);</span>
        }

<span class="nc" id="L552">        menu.open(p);</span>

<span class="nc bnc" id="L554" title="All 2 branches missed.">        if (!task.isEmpty()) {</span>
<span class="nc" id="L555">            task.start(menu.toInventory());</span>
        }
<span class="nc" id="L557">    }</span>

    private void displayItem(ChestMenu menu, PlayerProfile profile, Player p, Object item, ItemStack output, RecipeType recipeType, ItemStack[] recipe, AsyncRecipeChoiceTask task) {
<span class="nc" id="L560">        addBackButton(menu, 0, p, profile);</span>

<span class="nc" id="L562">        MenuClickHandler clickHandler = (pl, slot, itemstack, action) -&gt; {</span>
            try {
<span class="nc bnc" id="L564" title="All 4 branches missed.">                if (itemstack != null &amp;&amp; itemstack.getType() != Material.BARRIER) {</span>
<span class="nc" id="L565">                    displayItem(profile, itemstack, 0, true);</span>
                }
<span class="nc" id="L567">            } catch (Exception | LinkageError x) {</span>
<span class="nc" id="L568">                printErrorMessage(pl, x);</span>
<span class="nc" id="L569">            }</span>
<span class="nc" id="L570">            return false;</span>
        };

<span class="nc" id="L573">        boolean isSlimefunRecipe = item instanceof SlimefunItem;</span>

<span class="nc bnc" id="L575" title="All 2 branches missed.">        for (int i = 0; i &lt; 9; i++) {</span>
<span class="nc" id="L576">            ItemStack recipeItem = getDisplayItem(p, isSlimefunRecipe, recipe[i]);</span>
<span class="nc" id="L577">            menu.addItem(recipeSlots[i], recipeItem, clickHandler);</span>

<span class="nc bnc" id="L579" title="All 4 branches missed.">            if (recipeItem != null &amp;&amp; item instanceof MultiBlockMachine) {</span>
<span class="nc bnc" id="L580" title="All 2 branches missed.">                for (Tag&lt;Material&gt; tag : MultiBlock.getSupportedTags()) {</span>
<span class="nc bnc" id="L581" title="All 2 branches missed.">                    if (tag.isTagged(recipeItem.getType())) {</span>
<span class="nc" id="L582">                        task.add(recipeSlots[i], tag);</span>
<span class="nc" id="L583">                        break;</span>
                    }
<span class="nc" id="L585">                }</span>
            }
        }

<span class="nc" id="L589">        menu.addItem(10, recipeType.getItem(p), ChestMenuUtils.getEmptyClickHandler());</span>
<span class="nc" id="L590">        menu.addItem(16, output, ChestMenuUtils.getEmptyClickHandler());</span>
<span class="nc" id="L591">    }</span>

    @ParametersAreNonnullByDefault
    public void createHeader(Player p, PlayerProfile profile, ChestMenu menu) {
<span class="nc" id="L595">        Validate.notNull(p, &quot;The Player cannot be null!&quot;);</span>
<span class="nc" id="L596">        Validate.notNull(profile, &quot;The Profile cannot be null!&quot;);</span>
<span class="nc" id="L597">        Validate.notNull(menu, &quot;The Inventory cannot be null!&quot;);</span>

<span class="nc bnc" id="L599" title="All 2 branches missed.">        for (int i = 0; i &lt; 9; i++) {</span>
<span class="nc" id="L600">            menu.addItem(i, ChestMenuUtils.getBackground(), ChestMenuUtils.getEmptyClickHandler());</span>
        }

        // Settings Panel
<span class="nc" id="L604">        menu.addItem(1, ChestMenuUtils.getMenuButton(p));</span>
<span class="nc" id="L605">        menu.addMenuClickHandler(1, (pl, slot, item, action) -&gt; {</span>
<span class="nc" id="L606">            SlimefunGuideSettings.openSettings(pl, pl.getInventory().getItemInMainHand());</span>
<span class="nc" id="L607">            return false;</span>
        });

        // Search feature!
<span class="nc" id="L611">        menu.addItem(7, ChestMenuUtils.getSearchButton(p));</span>
<span class="nc" id="L612">        menu.addMenuClickHandler(7, (pl, slot, item, action) -&gt; {</span>
<span class="nc" id="L613">            pl.closeInventory();</span>

<span class="nc" id="L615">            Slimefun.getLocalization().sendMessage(pl, &quot;guide.search.message&quot;);</span>
<span class="nc" id="L616">            ChatInput.waitForPlayer(Slimefun.instance(), pl, msg -&gt; SlimefunGuide.openSearch(profile, msg, getMode(), isSurvivalMode()));</span>

<span class="nc" id="L618">            return false;</span>
        });

<span class="nc bnc" id="L621" title="All 2 branches missed.">        for (int i = 45; i &lt; 54; i++) {</span>
<span class="nc" id="L622">            menu.addItem(i, ChestMenuUtils.getBackground(), ChestMenuUtils.getEmptyClickHandler());</span>
        }
<span class="nc" id="L624">    }</span>

    private void addBackButton(ChestMenu menu, int slot, Player p, PlayerProfile profile) {
<span class="nc" id="L627">        GuideHistory history = profile.getGuideHistory();</span>

<span class="nc bnc" id="L629" title="All 4 branches missed.">        if (isSurvivalMode() &amp;&amp; history.size() &gt; 1) {</span>
<span class="nc" id="L630">            menu.addItem(slot, new CustomItemStack(ChestMenuUtils.getBackButton(p, &quot;&quot;, &quot;&amp;fLeft Click: &amp;7Go back to previous Page&quot;, &quot;&amp;fShift + left Click: &amp;7Go back to Main Menu&quot;)));</span>

<span class="nc" id="L632">            menu.addMenuClickHandler(slot, (pl, s, is, action) -&gt; {</span>
<span class="nc bnc" id="L633" title="All 2 branches missed.">                if (action.isShiftClicked()) {</span>
<span class="nc" id="L634">                    openMainMenu(profile, profile.getGuideHistory().getMainMenuPage());</span>
                } else {
<span class="nc" id="L636">                    history.goBack(this);</span>
                }
<span class="nc" id="L638">                return false;</span>
            });

        } else {
<span class="nc" id="L642">            menu.addItem(slot, new CustomItemStack(ChestMenuUtils.getBackButton(p, &quot;&quot;, ChatColor.GRAY + Slimefun.getLocalization().getMessage(p, &quot;guide.back.guide&quot;))));</span>
<span class="nc" id="L643">            menu.addMenuClickHandler(slot, (pl, s, is, action) -&gt; {</span>
<span class="nc" id="L644">                openMainMenu(profile, profile.getGuideHistory().getMainMenuPage());</span>
<span class="nc" id="L645">                return false;</span>
            });
        }
<span class="nc" id="L648">    }</span>

    @ParametersAreNonnullByDefault
    private static @Nonnull ItemStack getDisplayItem(Player p, boolean isSlimefunRecipe, ItemStack item) {
<span class="nc bnc" id="L652" title="All 2 branches missed.">        if (isSlimefunRecipe) {</span>
<span class="nc" id="L653">            SlimefunItem slimefunItem = SlimefunItem.getByItem(item);</span>

<span class="nc bnc" id="L655" title="All 2 branches missed.">            if (slimefunItem == null) {</span>
<span class="nc" id="L656">                return item;</span>
            }

<span class="nc bnc" id="L659" title="All 2 branches missed.">            String lore = hasPermission(p, slimefunItem) ? &quot;&amp;fNeeds to be unlocked in &quot; + slimefunItem.getItemGroup().getDisplayName(p) : &quot;&amp;fNo Permission&quot;;</span>
<span class="nc bnc" id="L660" title="All 2 branches missed.">            return slimefunItem.canUse(p, false) ? item : new CustomItemStack(Material.BARRIER, ItemUtils.getItemName(item), &quot;&amp;4&amp;l&quot; + Slimefun.getLocalization().getMessage(p, &quot;guide.locked&quot;), &quot;&quot;, lore);</span>
        } else {
<span class="nc" id="L662">            return item;</span>
        }
    }

    @ParametersAreNonnullByDefault
    private void displayRecipes(Player p, PlayerProfile profile, ChestMenu menu, RecipeDisplayItem sfItem, int page) {
<span class="nc" id="L668">        List&lt;ItemStack&gt; recipes = sfItem.getDisplayRecipes();</span>

<span class="nc bnc" id="L670" title="All 2 branches missed.">        if (!recipes.isEmpty()) {</span>
<span class="nc" id="L671">            menu.addItem(53, null);</span>

<span class="nc bnc" id="L673" title="All 2 branches missed.">            if (page == 0) {</span>
<span class="nc bnc" id="L674" title="All 2 branches missed.">                for (int i = 27; i &lt; 36; i++) {</span>
<span class="nc" id="L675">                    menu.replaceExistingItem(i, new CustomItemStack(ChestMenuUtils.getBackground(), sfItem.getRecipeSectionLabel(p)));</span>
<span class="nc" id="L676">                    menu.addMenuClickHandler(i, ChestMenuUtils.getEmptyClickHandler());</span>
                }
            }

<span class="nc" id="L680">            int pages = (recipes.size() - 1) / 18 + 1;</span>

<span class="nc" id="L682">            menu.replaceExistingItem(28, ChestMenuUtils.getPreviousButton(p, page + 1, pages));</span>
<span class="nc" id="L683">            menu.addMenuClickHandler(28, (pl, slot, itemstack, action) -&gt; {</span>
<span class="nc bnc" id="L684" title="All 2 branches missed.">                if (page &gt; 0) {</span>
<span class="nc" id="L685">                    displayRecipes(pl, profile, menu, sfItem, page - 1);</span>
<span class="nc" id="L686">                    pl.playSound(pl.getLocation(), sound, 1, 1);</span>
                }

<span class="nc" id="L689">                return false;</span>
            });

<span class="nc" id="L692">            menu.replaceExistingItem(34, ChestMenuUtils.getNextButton(p, page + 1, pages));</span>
<span class="nc" id="L693">            menu.addMenuClickHandler(34, (pl, slot, itemstack, action) -&gt; {</span>
<span class="nc bnc" id="L694" title="All 2 branches missed.">                if (recipes.size() &gt; (18 * (page + 1))) {</span>
<span class="nc" id="L695">                    displayRecipes(pl, profile, menu, sfItem, page + 1);</span>
<span class="nc" id="L696">                    pl.playSound(pl.getLocation(), sound, 1, 1);</span>
                }

<span class="nc" id="L699">                return false;</span>
            });

<span class="nc" id="L702">            int inputs = 36;</span>
<span class="nc" id="L703">            int outputs = 45;</span>

<span class="nc bnc" id="L705" title="All 2 branches missed.">            for (int i = 0; i &lt; 18; i++) {</span>
                int slot;

<span class="nc bnc" id="L708" title="All 2 branches missed.">                if (i % 2 == 0) {</span>
<span class="nc" id="L709">                    slot = inputs;</span>
<span class="nc" id="L710">                    inputs++;</span>
                } else {
<span class="nc" id="L712">                    slot = outputs;</span>
<span class="nc" id="L713">                    outputs++;</span>
                }

<span class="nc" id="L716">                addDisplayRecipe(menu, profile, recipes, slot, i, page);</span>
            }
        }
<span class="nc" id="L719">    }</span>

    private void addDisplayRecipe(ChestMenu menu, PlayerProfile profile, List&lt;ItemStack&gt; recipes, int slot, int i, int page) {
<span class="nc bnc" id="L722" title="All 2 branches missed.">        if ((i + (page * 18)) &lt; recipes.size()) {</span>
<span class="nc" id="L723">            ItemStack displayItem = recipes.get(i + (page * 18));</span>

            /*
             * We want to clone this item to avoid corrupting the original
             * but we wanna make sure no stupid addon creator sneaked some nulls in here
             */
<span class="nc bnc" id="L729" title="All 2 branches missed.">            if (displayItem != null) {</span>
<span class="nc" id="L730">                displayItem = displayItem.clone();</span>
            }

<span class="nc" id="L733">            menu.replaceExistingItem(slot, displayItem);</span>

<span class="nc bnc" id="L735" title="All 2 branches missed.">            if (page == 0) {</span>
<span class="nc" id="L736">                menu.addMenuClickHandler(slot, (pl, s, itemstack, action) -&gt; {</span>
<span class="nc" id="L737">                    displayItem(profile, itemstack, 0, true);</span>
<span class="nc" id="L738">                    return false;</span>
                });
            }
<span class="nc" id="L741">        } else {</span>
<span class="nc" id="L742">            menu.replaceExistingItem(slot, null);</span>
<span class="nc" id="L743">            menu.addMenuClickHandler(slot, ChestMenuUtils.getEmptyClickHandler());</span>
        }
<span class="nc" id="L745">    }</span>

    @ParametersAreNonnullByDefault
    private static boolean hasPermission(Player p, SlimefunItem item) {
<span class="nc" id="L749">        return Slimefun.getPermissionsService().hasPermission(p, item);</span>
    }

    private @Nonnull ChestMenu create(@Nonnull Player p) {
<span class="nc" id="L753">        ChestMenu menu = new ChestMenu(Slimefun.getLocalization().getMessage(p, &quot;guide.title.main&quot;));</span>

<span class="nc" id="L755">        menu.setEmptySlotsClickable(false);</span>
<span class="nc" id="L756">        menu.addMenuOpeningHandler(pl -&gt; pl.playSound(pl.getLocation(), sound, 1, 1));</span>
<span class="nc" id="L757">        return menu;</span>
    }

    @ParametersAreNonnullByDefault
    private void printErrorMessage(Player p, Throwable x) {
<span class="nc" id="L762">        p.sendMessage(ChatColor.DARK_RED + &quot;An internal server error has occurred. Please inform an admin, check the console for further info.&quot;);</span>
<span class="nc" id="L763">        Slimefun.logger().log(Level.SEVERE, &quot;An error has occurred while trying to open a SlimefunItem in the guide!&quot;, x);</span>
<span class="nc" id="L764">    }</span>

    @ParametersAreNonnullByDefault
    private void printErrorMessage(Player p, SlimefunItem item, Throwable x) {
<span class="nc" id="L768">        p.sendMessage(ChatColor.DARK_RED + &quot;An internal server error has occurred. Please inform an admin, check the console for further info.&quot;);</span>
<span class="nc" id="L769">        item.error(&quot;This item has caused an error message to be thrown while viewing it in the Slimefun guide.&quot;, x);</span>
<span class="nc" id="L770">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>